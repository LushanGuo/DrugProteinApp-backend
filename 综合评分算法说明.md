# 综合评分算法说明

## 概述

综合评分算法使用**真实的 Vina 分子对接结果**和 **ADMET 预测数据**来评估化合物的药物开发潜力。

## 数据来源

### 1. Vina 分子对接数据（来自 `docking_results` 表）
- **affinity**: 结合亲和力（kcal/mol），值越负表示结合越强
- **similarity_score**: 与已知药物的结构相似度（0-1）

### 2. ADMET 预测数据（来自 `admet_results` 表）
- **herg_toxicity**: hERG 心脏毒性风险（0-1），值越高风险越大
- **ames_toxicity**: Ames 致突变性（0=阴性，1=阳性）
- **liver_toxicity**: 肝毒性（0=无，1=有）
- **absorption**: 吸收性（0-1），值越高吸收越好
- **metabolism**: 代谢稳定性（0-1），值越高越稳定

### 3. 化合物理化性质（来自 `compounds` 表）
- **molecular_weight**: 分子量
- **log_p**: 脂水分配系数
- **hbd**: 氢键供体数
- **hba**: 氢键受体数
- **heavy_atom_count**: 重原子数

---

## 评分体系（总分 100 分）

### 模块一：生物活性与效能（Potency）—— 45 分

#### A. 分子对接亲和力（30 分）
- **数据来源**: `docking_results.affinity`
- **评分规则**:
  - ≤ -10.0 kcal/mol: 30 分（极强结合）
  - -10.0 到 -6.0: 线性插值（0-30 分）
  - > -6.0 kcal/mol: 0 分（结合力弱）
- **标签**: 
  - "🌟 极强结合" (≤ -10.0)
  - "结合力弱" (> -6.0)

#### B. 结构相似性（10 分）
- **数据来源**: `docking_results.similarity_score`
- **评分规则**:
  - ≥ 0.7: 10 分（骨架成熟）
  - 0.5-0.7: 5 分
  - < 0.5: 2 分（骨架新颖，鼓励创新）

#### C. 配体效率 LE（5 分）
- **计算公式**: LE = -affinity / heavy_atom_count
- **评分规则**:
  - ≥ 0.3: 5 分（高配体效率）
  - < 0.3: 0 分

---

### 模块二：ADMET 安全性（Safety）—— 35 分

#### A. hERG 心脏毒性（15 分 + 熔断机制）
- **数据来源**: `admet_results.herg_toxicity`
- **评分规则**:
  - > 0.7: **触发熔断**，总分归零，终止开发
  - < 0.3: 15 分（心脏安全性佳）
  - 0.3-0.7: 5 分（hERG 风险中等）
- **熔断说明**: hERG 毒性过高会导致致死性心律失常，采用一票否决制

#### B. AMES 致突变性（10 分）
- **数据来源**: `admet_results.ames_toxicity`
- **评分规则**:
  - 0（阴性）: 10 分
  - 1（阳性）: 0 分，标记"致突变风险"

#### C. 肝毒性（10 分）
- **数据来源**: `admet_results.liver_toxicity`
- **评分规则**:
  - 0（无毒性）: 10 分
  - 1（有毒性）: 0 分，标记"肝毒性风险"

---

### 模块三：理化性质与成药性（Drug-Likeness）—— 20 分

#### D. 吸收性 Absorption（5 分）
- **数据来源**: `admet_results.absorption`
- **评分规则**:
  - ≥ 0.7: 5 分（吸收性优）
  - 0.5-0.7: 3 分
  - < 0.5: 1 分（吸收性较差）

#### E. 代谢稳定性 Metabolism（5 分）
- **数据来源**: `admet_results.metabolism`
- **评分规则**:
  - ≥ 0.7: 5 分（代谢稳定）
  - 0.5-0.7: 3 分
  - < 0.5: 1 分（代谢不稳定）

#### F. LogP 脂水分配系数（5 分）
- **数据来源**: `compounds.log_p`
- **评分规则**:
  - 0-3: 5 分（理想范围）
  - 3-4 或 -1-0: 3 分
  - 其他: 0 分，标记"LogP 不佳"

#### G. 分子量 MW（3 分）
- **数据来源**: `compounds.molecular_weight`
- **评分规则**:
  - 300-500: 3 分（理想范围）
  - 250-300 或 500-550: 2 分
  - 其他: 0 分

#### H. 氢键（2 分）
- **数据来源**: `compounds.hbd`, `compounds.hba`
- **评分规则**:
  - HBD ≤ 5 且 HBA ≤ 10: 2 分（符合 Lipinski 规则）
  - 其他: 1 分

---

## 评分流程

```
1. 从数据库读取化合物基础信息
   ↓
2. 读取 Vina 对接结果（affinity, similarity_score）
   ↓
3. 读取 ADMET 预测结果（5 个维度）
   ↓
4. 检查 hERG 熔断条件（> 0.7）
   ├─ 是 → 总分归零，终止评估
   └─ 否 → 继续评估
   ↓
5. 计算安全性得分（35 分）
   ↓
6. 计算效能得分（45 分）
   ↓
7. 计算成药性得分（20 分，含吸收和代谢）
   ↓
8. 汇总总分，生成标签和建议
   ↓
9. 保存到 analysis_reports 表
```

---

## 输出结果

### ScoringResultDTO 字段
```java
{
  "compoundId": 1,
  "totalScore": 78.5,           // 总分（0-100）
  "potencyScore": 35.2,         // 效能得分（0-45）
  "safetyScore": 30.0,          // 安全性得分（0-35）
  "druglikenessScore": 13.3,    // 成药性得分（0-20）
  "vetoed": false,              // 是否被熔断
  "adviceTags": [               // 标签列表
    "心脏安全性佳",
    "🌟 极强结合",
    "吸收性优",
    "代谢稳定"
  ],
  "expertAdvice": "🛡️ 安全性得分：30.0 / 35.0\n🎯 效能得分：35.2 / 45.0 (Affinity: -9.2 kcal/mol)\n💊 成药性得分：13.3 / 20.0 (含吸收: 0.85, 代谢: 0.72)\n"
}
```

---

## 关键特性

### 1. 真实数据驱动
- 所有评分都基于数据库中的真实预测结果
- 不使用任何模拟或假数据

### 2. 安全性优先
- hERG 心脏毒性采用熔断机制
- 一旦触发，立即终止评估，总分归零

### 3. 全面评估
- 涵盖生物活性、安全性、成药性三大维度
- 整合 Vina 对接和 ADMET 五维预测数据

### 4. 智能建议
- 根据评分结果生成标签和专家建议
- 指出潜在风险和优化方向

---

## 使用示例

### API 调用
```bash
POST http://localhost:8080/api/scoring/analyze/1
```

### 响应示例
```json
{
  "success": true,
  "data": {
    "compoundId": 1,
    "totalScore": 78.5,
    "potencyScore": 35.2,
    "safetyScore": 30.0,
    "druglikenessScore": 13.3,
    "vetoed": false,
    "adviceTags": [
      "心脏安全性佳",
      "🌟 极强结合",
      "吸收性优",
      "代谢稳定"
    ],
    "expertAdvice": "🛡️ 安全性得分：30.0 / 35.0\n🎯 效能得分：35.2 / 45.0 (Affinity: -9.2 kcal/mol)\n💊 成药性得分：13.3 / 20.0 (含吸收: 0.85, 代谢: 0.72)\n"
  }
}
```

---

## 注意事项

1. **数据完整性**: 确保 Vina 对接和 ADMET 预测都已完成
2. **熔断机制**: hERG > 0.7 会触发熔断，无法继续开发
3. **评分权重**: 效能 45% > 安全性 35% > 成药性 20%
4. **五维数据**: ADMET 现在包含完整的五个维度（hERG, Ames, Liver, Absorption, Metabolism）

---

## 更新日志

### v2.0 (2026-01-28)
- ✅ 集成真实的 Vina 对接数据（affinity, similarity_score）
- ✅ 集成真实的 ADMET 五维预测数据
- ✅ 新增吸收性（absorption）评分（5 分）
- ✅ 新增代谢稳定性（metabolism）评分（5 分）
- ✅ 调整成药性模块权重分配（LogP: 5 分，MW: 3 分，氢键: 2 分）
- ✅ 移除所有模拟数据（mock data）
- ✅ 优化评分逻辑和建议生成

### v1.0 (初始版本)
- 基础评分框架
- 三维评分体系（效能、安全性、成药性）
- hERG 熔断机制
