# 3D 可视化使用指南

## 📋 概述

系统现在直接从 `resources/3ddata/pdb文件/pdb文件/` 目录读取 PDB 文件，无需数据库存储。

---

## 📁 文件结构

```
platform/src/main/resources/
├── 3ddata/
│   └── pdb文件/
│       └── pdb文件/
│           ├── acacetin.pdb        # 金合欢素
│           ├── quercetin.pdb       # 槲皮素
│           ├── curcumin.pdb        # 姜黄素
│           └── ... (共 48 个文件)
└── structures/
    └── receptor_cdk2.pdb           # CDK2 受体蛋白
```

---

## 🚀 使用方法

### 1. 确保文件存在

检查 `platform/src/main/resources/3ddata/pdb文件/pdb文件/` 目录下有 48 个 PDB 文件。

### 2. 启动应用

```bash
cd platform
mvn spring-boot:run
```

### 3. 测试接口

#### 测试 3D 可视化接口

```bash
# 获取化合物 1 的 3D 数据
GET http://localhost:8080/api/visual/1
```

**预期响应：**
```json
{
  "proteinPdb": "HETATM    1  O   UNK     0...",  // 受体蛋白 PDB
  "dockedLigandPdbqt": "HETATM    1  O   UNK...", // 配体 PDB
  "bindingEnergy": -8.0                            // 模拟的结合能
}
```

#### 测试结构数据接口

```bash
# 获取化合物 1 的结构数据
GET http://localhost:8080/api/compounds/1/structure
```

---

## 🔧 工作原理

### 文件名映射

系统根据化合物的 **英文名** 查找对应的 PDB 文件：

| 化合物中文名 | 英文名 | PDB 文件名 |
|------------|--------|-----------|
| 金合欢素 | Acacetin | acacetin.pdb |
| 槲皮素 | Quercetin | quercetin.pdb |
| 姜黄素 | Curcumin | curcumin.pdb |

**规则：**
- 英文名转小写
- 空格保持不变（如 "biochanin A.pdb"）

### 数据流程

```
前端请求 → VisualController 
         → Visual3DService 
         → 读取 receptor_cdk2.pdb (受体)
         → 读取 {englishName}.pdb (配体)
         → 返回 JSON
```

---

## 📊 API 接口

### 1. GET /api/visual/{compoundId}

获取 3D 可视化数据（用于 3D 查看器）

**响应字段：**
- `proteinPdb`: 受体蛋白 PDB 内容
- `dockedLigandPdbqt`: 配体 PDB 内容
- `bindingEnergy`: 结合能（模拟值）

### 2. GET /api/compounds/{id}/structure

获取化合物结构数据

**响应字段：**
- `compoundId`: 化合物 ID
- `compoundName`: 化合物名称
- `receptorPdb`: 受体 PDB
- `ligandPdbqt`: 配体 PDB

### 3. GET /api/compounds/top10

获取 Top 10 化合物（按模拟的结合能排序）

---

## 🎨 前端集成

### React Native 示例

```typescript
// 获取 3D 数据
const load3DData = async (compoundId: number) => {
  try {
    const response = await api.get(`/api/visual/${compoundId}`);
    const { proteinPdb, dockedLigandPdbqt, bindingEnergy } = response.data;
    
    console.log('蛋白 PDB 长度:', proteinPdb.length);
    console.log('配体 PDB 长度:', dockedLigandPdbqt.length);
    console.log('结合能:', bindingEnergy);
    
    // 渲染 3D 模型
    setReceptor(proteinPdb);
    setLigand(dockedLigandPdbqt);
  } catch (error) {
    console.error('加载 3D 数据失败:', error);
  }
};
```

---

## ⚠️ 注意事项

### 1. 文件名必须匹配

确保 PDB 文件名与数据库中的英文名一致：
- 文件名：小写
- 空格：保持不变
- 扩展名：`.pdb`

### 2. 英文名必须正确

在 `compounds` 表中，`english_name` 字段必须填写正确。

**检查方法：**
```sql
SELECT id, name, english_name FROM compounds WHERE id = 1;
```

### 3. 文件编码

PDB 文件必须使用 UTF-8 编码。

---

## 🐛 故障排除

### 问题 1：找不到 PDB 文件

**错误：** `找不到配体文件: xxx.pdb`

**解决：**
1. 检查文件是否存在
2. 检查文件名是否正确（小写）
3. 检查英文名是否匹配

### 问题 2：PDB 数据为空

**错误：** `proteinPdb` 或 `dockedLigandPdbqt` 为空

**解决：**
1. 检查文件是否为空
2. 检查文件路径是否正确
3. 查看后端日志

### 问题 3：前端无法显示 3D 模型

**解决：**
1. 检查 API 返回的数据长度
2. 检查前端 PDB 解析器
3. 查看浏览器控制台错误

---

## 📝 后端日志

成功时应该看到：

```
INFO: 开始获取化合物 1 的 3D 可视化数据
INFO: 成功读取受体蛋白 PDB，长度: 1234 字符
INFO: 成功读取配体 Acacetin PDB，长度: 567 字符
```

失败时会看到：

```
ERROR: 读取 3D 数据失败: compoundId=1, 错误: 找不到配体文件: xxx.pdb
```

---

## 🎯 测试清单

- [ ] 启动应用成功
- [ ] 访问 `/api/visual/1` 返回数据
- [ ] `proteinPdb` 长度 > 1000
- [ ] `dockedLigandPdbqt` 长度 > 500
- [ ] `bindingEnergy` 是负数
- [ ] 前端可以显示 3D 模型
- [ ] 可以旋转和缩放

---

## 📚 相关文档

- `前端接口文档.md` - 完整的 API 文档
- `综合评分算法文档.md` - 评分算法说明
- `POSTMAN_快速开始.md` - API 测试指南

---

**版本：** v2.0.0  
**更新日期：** 2026-01-23  
**状态：** ✅ 简化完成，直接从文件读取
