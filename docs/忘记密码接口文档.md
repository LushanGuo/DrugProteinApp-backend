# 忘记密码接口文档

## 概述

忘记密码功能采用手机验证码方式重置密码，分为三个步骤：

1. 发送验证码到手机
2. 验证验证码
3. 重置密码

---

## API 接口

### 1. 发送验证码

**接口：** `POST /api/auth/forgot-password/send-code`

**请求体：**
```json
{
  "phone": "13800138000"
}
```

**字段说明：**
- `phone`: 手机号（必填，11位，1开头）

**成功响应：**
```json
{
  "success": true,
  "message": "验证码已发送",
  "data": null
}
```

**错误响应：**

1. 手机号未注册：
```json
{
  "success": false,
  "message": "手机号未注册",
  "data": null
}
```

2. 发送频率限制：
```json
{
  "success": false,
  "message": "请59秒后再试",
  "data": null
}
```

**说明：**
- 验证码有效期：5分钟
- 发送频率限制：1分钟内只能发送1次
- 开发环境：验证码会打印在后端控制台
- 生产环境：验证码会通过短信发送

---

### 2. 验证验证码

**接口：** `POST /api/auth/forgot-password/verify-code`

**请求体：**
```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

**字段说明：**
- `phone`: 手机号（必填）
- `code`: 验证码（必填，6位数字）

**成功响应：**
```json
{
  "success": true,
  "message": "验证成功",
  "data": null
}
```

**错误响应：**

1. 验证码已过期：
```json
{
  "success": false,
  "message": "验证码已过期，请重新获取",
  "data": null
}
```

2. 验证码错误：
```json
{
  "success": false,
  "message": "验证码错误，还可以尝试4次",
  "data": null
}
```

3. 错误次数过多：
```json
{
  "success": false,
  "message": "验证码错误次数过多，请重新获取验证码",
  "data": null
}
```

**说明：**
- 验证码错误5次后会被锁定
- 验证成功后，验证状态有效期延长到10分钟

---

### 3. 重置密码

**接口：** `POST /api/auth/forgot-password/reset`

**请求体：**
```json
{
  "phone": "13800138000",
  "code": "123456",
  "newPassword": "newpass123"
}
```

**字段说明：**
- `phone`: 手机号（必填）
- `code`: 验证码（必填，6位数字）
- `newPassword`: 新密码（必填，6-20位）

**成功响应：**
```json
{
  "success": true,
  "message": "密码重置成功",
  "data": null
}
```

**错误响应：**

1. 验证码未验证：
```json
{
  "success": false,
  "message": "请先验证验证码",
  "data": null
}
```

2. 验证码不匹配：
```json
{
  "success": false,
  "message": "验证码不匹配",
  "data": null
}
```

3. 密码格式错误：
```json
{
  "success": false,
  "message": "密码长度必须在6-20位之间",
  "data": null
}
```

**说明：**
- 必须先调用验证接口验证验证码
- 密码会使用 BCrypt 加密存储
- 重置成功后，所有验证码记录会被清除

---

## 使用流程

### 完整流程

```
1. 用户输入手机号
   ↓
2. 调用发送验证码接口
   ↓
3. 用户收到验证码（开发环境查看控制台）
   ↓
4. 用户输入验证码
   ↓
5. 调用验证验证码接口
   ↓
6. 用户输入新密码
   ↓
7. 调用重置密码接口
   ↓
8. 密码重置成功，跳转登录页
```

---

## React Native 示例

```typescript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://10.0.2.2:8080',
});

// 1. 发送验证码
export const sendResetCode = async (phone: string) => {
  const response = await api.post('/api/auth/forgot-password/send-code', {
    phone,
  });
  return response.data;
};

// 2. 验证验证码
export const verifyResetCode = async (phone: string, code: string) => {
  const response = await api.post('/api/auth/forgot-password/verify-code', {
    phone,
    code,
  });
  return response.data;
};

// 3. 重置密码
export const resetPassword = async (
  phone: string,
  code: string,
  newPassword: string
) => {
  const response = await api.post('/api/auth/forgot-password/reset', {
    phone,
    code,
    newPassword,
  });
  return response.data;
};

// 使用示例
const handleForgotPassword = async () => {
  try {
    // 步骤1：发送验证码
    await sendResetCode('13800138000');
    Alert.alert('成功', '验证码已发送');
    
    // 步骤2：验证验证码
    await verifyResetCode('13800138000', '123456');
    Alert.alert('成功', '验证成功');
    
    // 步骤3：重置密码
    await resetPassword('13800138000', '123456', 'newpass123');
    Alert.alert('成功', '密码重置成功');
    
    // 跳转到登录页
    navigation.navigate('Login');
  } catch (error) {
    Alert.alert('错误', error.response?.data?.message || '操作失败');
  }
};
```

---

## 测试用例

### 命令行测试

```bash
# 1. 发送验证码
curl -X POST http://localhost:8080/api/auth/forgot-password/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"18300899350"}'

# 查看后端控制台获取验证码

# 2. 验证验证码
curl -X POST http://localhost:8080/api/auth/forgot-password/verify-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"18300899350","code":"123456"}'

# 3. 重置密码
curl -X POST http://localhost:8080/api/auth/forgot-password/reset \
  -H "Content-Type: application/json" \
  -d '{"phone":"18300899350","code":"123456","newPassword":"654321"}'

# 4. 用新密码登录
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phoneOrEmail":"18300899350","password":"654321"}'
```

### Windows 批处理测试

```bash
测试忘记密码.bat
```

---

## 安全特性

### 1. 验证码安全
- ✅ 6位随机数字
- ✅ 5分钟有效期
- ✅ 一次性使用（重置后删除）
- ✅ 验证成功后延长有效期到10分钟

### 2. 频率限制
- ✅ 同一手机号1分钟内只能发送1次
- ✅ 验证码错误5次后锁定

### 3. 密码安全
- ✅ 使用 BCrypt 加密
- ✅ 最少6位，最多20位

### 4. 防止暴力破解
- ✅ 验证码错误5次后需要重新获取
- ✅ 验证码有效期限制

---

## 开发环境 vs 生产环境

### 开发环境
- ✅ 验证码打印在控制台
- ✅ 使用内存存储（ConcurrentHashMap）
- ✅ 不需要配置短信服务
- ✅ 不需要配置 Redis

### 生产环境建议
- ⚠️ 使用真实短信服务（阿里云/腾讯云）
- ⚠️ 使用 Redis 存储验证码
- ⚠️ 添加图形验证码
- ⚠️ 添加 IP 限制
- ⚠️ 记录所有操作日志

---

## 常见问题

### Q1: 验证码在哪里查看？

A: 开发环境下，验证码会打印在后端控制台，格式如下：
```
============================================================
【验证码】手机号: 18300899350
【验证码】验证码: 123456
【验证码】有效期: 5分钟
============================================================
```

### Q2: 验证码过期了怎么办？

A: 重新调用发送验证码接口获取新的验证码。

### Q3: 验证码错误次数过多怎么办？

A: 需要重新调用发送验证码接口获取新的验证码。

### Q4: 可以跳过验证直接重置密码吗？

A: 不可以，必须先验证验证码才能重置密码。

### Q5: 重置密码后需要重新登录吗？

A: 是的，密码重置成功后需要使用新密码登录。

---

## 错误码说明

| HTTP 状态码 | 说明 |
|------------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 500 | 服务器内部错误 |

---

## 相关文档

- [认证接口文档](认证接口文档.md)
- [前端接口文档](前端接口文档.md)
- [数据库配置指南](DATABASE_SETUP.md)

---

**最后更新：** 2026-01-24  
**版本：** v1.0.0  
**状态：** ✅ 开发环境可用
